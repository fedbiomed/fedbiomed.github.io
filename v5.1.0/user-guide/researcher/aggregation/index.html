<!DOCTYPE html><html> <head><meta charset=UTF-8><meta name=viewport content="width=device-width, initial-scale=1"><meta name=robots context="index, archive"><!--  --><script>
      const versions_json = "../../../../versions.json";
      const search_worker_js = "../../../assets/javascript/search-worker.js";
      const search_index_json = "../../../search/search_index.json";
      const base_url = '../../..';
    </script><!-- Site title --><title>Parameter Aggregation in Fed-BioMed - Fed-BioMed</title><link rel=icon type=image/x-icon href=../../../favicon.ico><!-- Page description --><meta name=description content="Aggregation of model parameters in Fed-BioMed for dealing with data heterogeneity."><!-- Page keywords --><meta name=keywords content="parameter aggregation,aggregation,federated average"><!-- Page author --><!-- Latest compiled and minified CSS --><link rel=stylesheet href=https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css integrity=sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu crossorigin=anonymous><!-- Bootstrap Icons --><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css><link href=../../../assets/_mkdocstrings.css rel=stylesheet><link href=../../../assets/css/style.css rel=stylesheet></head> <body> <header> <div class="container-fluid top-bar"> <div class=brand> <a href=/ > <img src=../../../assets/img/fedbiomed-logo-small.png> </a> </div> <nav class=top> <ul> <li class> <a href=../../..>Home</a> </li> <li class> <a href=../../../getting-started/what-is-fedbiomed/ >User Documentation</a> </li> <li class> <a href=../../../pages/about-us/ >About</a> </li> <li id=clicker class=has-sub> More <i class="bi bi-chevron-down"></i> <ul class=sub-nav-menu> <li class> <a href=../../../#funding>Funding</a> </li> <li class> <a href=../../../news/ >News</a> </li> <li class> <a href=../../../#contributors>Contributors</a> </li> <li class> <a href=../../../#users>Users</a> </li> <li class> <a href=../../../pages/roadmap/ >Roadmap</a> </li> <li class> <a href=../../../#contact-us>Contact Us</a> </li> </ul> </li> </ul> </nav> </div> <div class="container-fluid top-bar-mobile"> <div class=mobile-bar> <div class=brand> <a href=../../../ > <img src=../../../assets/img/fedbiomed-logo-small.png> </a> </div> <div class=hum-menu> <img class=open src=../../../assets/img/menu.svg> <img class=close style=display:none src=../../../assets/img/cancel.svg> </div> </div> <nav class=top-mobile> <ul> <li class> <a href=../../..>Home</a> </li> <li class> <a href=../../../getting-started/what-is-fedbiomed/ >User Documentation</a> </li> <li class> <a href=../../../pages/about-us/ >About</a> </li> <li id=clicker class=has-sub> More <i class="bi bi-chevron-down"></i> <ul class=sub-nav-menu> <li class> <a href=../../../#funding>Funding</a> </li> <li class> <a href=../../../news/ >News</a> </li> <li class> <a href=../../../#contributors>Contributors</a> </li> <li class> <a href=../../../#users>Users</a> </li> <li class> <a href=../../../pages/roadmap/ >Roadmap</a> </li> <li class> <a href=../../../#contact-us>Contact Us</a> </li> </ul> </li> </ul> </nav> </div> </header> <div class=main> <!-- Home page --> <div class=container-fluid> <div class=doc-row> <div class=left-col> <div class=sidebar-doc> <nav class=sidebar-inner> <ul class="sidebar-menu-left sub"> <li data-adress=sub-1 class=has-sub-side> <div href class="parent-list "> Getting Started <i class="bi bi-chevron-down"></i> </div> <ul class="sub-sidebar-menu sub "> <li class> <a href=../../../getting-started/what-is-fedbiomed/ class>What's Fed-BioMed</a> </li> <li class> <a href=../../../getting-started/getting-started/ class>Basic Example</a> </li> <li class> <a href=../../../getting-started/fedbiomed-architecture/ class>Fedbiomed Architecture</a> </li> <li class> <a href=../../../getting-started/fedbiomed-workflow/ class>Fedbiomed Workflow</a> </li> </ul> </li> <li data-adress=sub-1 class=has-sub-side> <div href class="parent-list "> Tutorials <i class="bi bi-chevron-down"></i> </div> <ul class="sub-sidebar-menu sub "> <li data-adress=sub-1 class=has-sub-side> <div href class="parent-list "> Installation <i class="bi bi-chevron-down"></i> </div> <ul class="sub-sidebar-menu sub "> <li class> <a href=../../../tutorials/installation/0-basic-software-installation/ class>Software Installation</a> </li> <li class> <a href=../../../tutorials/installation/1-setting-up-environment/ class>Setting Up Environment</a> </li> </ul> </li> <li data-adress=sub-1 class=has-sub-side> <div href class="parent-list "> PyTorch <i class="bi bi-chevron-down"></i> </div> <ul class="sub-sidebar-menu sub "> <li class> <a href=../../../tutorials/pytorch/01_PyTorch_MNIST_Single_Node_Tutorial/ class>PyTorch MNIST Basic Example</a> </li> <li class> <a href=../../../tutorials/pytorch/02_Create_Your_Custom_Training_Plan/ class>How to Create Your Custom PyTorch Training Plan</a> </li> <li class> <a href=../../../tutorials/pytorch/03_PyTorch_MNIST_local_vs_Federated/ class>MNIST classification with PyTorch, comparing federated model vs model trained locally</a> </li> <li class> <a href=../../../tutorials/pytorch/04_PyTorch_Used_Cars_Dataset_Example/ class>PyTorch Used Cars Dataset Example</a> </li> <li class> <a href=../../../tutorials/pytorch/05-Aggregation_in_Fed-BioMed/ class>PyTorch aggregation methods in Fed-BioMed</a> </li> </ul> </li> <li data-adress=sub-1 class=has-sub-side> <div href class="parent-list "> MONAI <i class="bi bi-chevron-down"></i> </div> <ul class="sub-sidebar-menu sub "> <li class> <a href=../../../tutorials/monai/01_monai-2d-image-classification/ class>Federated 2d image classification with MONAI</a> </li> <li class> <a href=../../../tutorials/monai/02_monai-2d-image-registration/ class>Federated 2d XRay registration with MONAI</a> </li> </ul> </li> <li data-adress=sub-1 class=has-sub-side> <div href class="parent-list "> Scikit-Learn <i class="bi bi-chevron-down"></i> </div> <ul class="sub-sidebar-menu sub "> <li class> <a href=../../../tutorials/scikit-learn/01_sklearn_MNIST_classification_tutorial/ class>MNIST classification with Scikit-Learn Classifier (Perceptron)</a> </li> <li class> <a href=../../../tutorials/scikit-learn/02_sklearn_sgd_regressor_tutorial/ class>Fed-BioMed to train a federated SGD regressor model</a> </li> <li class> <a href=../../../tutorials/scikit-learn/03-other-scikit-learn-models/ class>Implementing other Scikit Learn models for Federated Learning</a> </li> </ul> </li> <li data-adress=sub-1 class=has-sub-side> <div href class="parent-list "> Optimizers <i class="bi bi-chevron-down"></i> </div> <ul class="sub-sidebar-menu sub "> <li class> <a href=../../../tutorials/optimizers/01-fedopt-and-scaffold/ class>Advanced optimizers in Fed-BioMed</a> </li> </ul> </li> <li data-adress=sub-1 class=has-sub-side> <div href class="parent-list "> FLamby <i class="bi bi-chevron-down"></i> </div> <ul class="sub-sidebar-menu sub "> <li class> <a href=../../../tutorials/flamby/flamby/ class>General Concepts</a> </li> <li class> <a href=../../../tutorials/flamby/flamby-integration-into-fedbiomed/ class>FLamby integration in Fed-BioMed</a> </li> </ul> </li> <li data-adress=sub-1 class=has-sub-side> <div href class="parent-list "> Advanced <i class="bi bi-chevron-down"></i> </div> <ul class="sub-sidebar-menu sub "> <li class> <a href=../../../tutorials/advanced/in-depth-experiment-configuration/ class>In Depth Experiment Configuration</a> </li> <li class> <a href=../../../tutorials/advanced/training-with-gpu/ class>PyTorch model training using a GPU</a> </li> <li class> <a href=../../../tutorials/advanced/breakpoints/ class>Breakpoints</a> </li> </ul> </li> <li data-adress=sub-1 class=has-sub-side> <div href class="parent-list "> Security <i class="bi bi-chevron-down"></i> </div> <ul class="sub-sidebar-menu sub "> <li class> <a href=../../../tutorials/security/differential-privacy-with-opacus-on-fedbiomed/ class>Using Differential Privacy with OPACUS on Fed-BioMed</a> </li> <li class> <a href=../../../tutorials/security/non-private-local-central-dp-monai-2d-image-registration/ class>Local and Central DP with Fed-BioMed: MONAI 2d image registration</a> </li> <li class> <a href=../../../tutorials/security/training-with-approved-training-plans/ class>Training Process with Training Plan Management</a> </li> <li class> <a href=../../../tutorials/security/secure-aggregation/ class>Training with Secure Aggregation</a> </li> </ul> </li> <li data-adress=sub-1 class=has-sub-side> <div href class="parent-list "> Biomedical data <i class="bi bi-chevron-down"></i> </div> <ul class="sub-sidebar-menu sub "> <li class> <a href=../../../tutorials/medical/medical-image-segmentation-unet-library/ class>Brain Segmentation</a> </li> </ul> </li> </ul> </li> <li data-adress=sub-1 class="current has-sub-side"> <div href class="parent-list current "> User Guide <i class="bi bi-chevron-down"></i> </div> <ul class="sub-sidebar-menu sub active "> <li class> <a href=../../glossary/ class>Glossary</a> </li> <li data-adress=sub-1 class=has-sub-side> <div href class="parent-list "> Deployment <i class="bi bi-chevron-down"></i> </div> <ul class="sub-sidebar-menu sub "> <li class> <a href=../../deployment/deployment/ class>Introduction</a> </li> <li class> <a href=../../deployment/deployment-vpn/ class>VPN Deployment</a> </li> <li class> <a href=../../deployment/matrix/ class>Network matrix</a> </li> <li class> <a href=../../deployment/security-model/ class>Security model</a> </li> </ul> </li> <li data-adress=sub-1 class=has-sub-side> <div href class="parent-list "> Node <i class="bi bi-chevron-down"></i> </div> <ul class="sub-sidebar-menu sub "> <li class> <a href=../../nodes/configuring-nodes/ class>Configuring Nodes</a> </li> <li class> <a href=../../nodes/deploying-datasets/ class>Deploying Datasets</a> </li> <li class> <a href=../../nodes/training-plan-security-manager/ class>Training Plan Management</a> </li> <li class> <a href=../../nodes/using-gpu/ class>Using GPU</a> </li> <li class> <a href=../../nodes/node-gui/ class>Node GUI</a> </li> </ul> </li> <li data-adress=sub-1 class="current has-sub-side"> <div href class="parent-list current "> Researcher <i class="bi bi-chevron-down"></i> </div> <ul class="sub-sidebar-menu sub active "> <li class> <a class href=../configuring-researcher.md>Configuring Researcher</a> </li> <li class> <a href=../training-plan/ class>Training Plan</a> </li> <li class> <a href=../training-data/ class>Training Data</a> </li> <li class> <a href=../experiment/ class>Experiment</a> </li> <li class=current> <a href=./ class="link current">Aggregation</a> </li> <li class> <a href=../listing-datasets-and-selecting-nodes/ class>Listing Datasets and Selecting Nodes</a> </li> <li class> <a href=../model-testing-during-federated-training/ class>Model Validation on the Node Side</a> </li> <li class> <a href=../tensorboard/ class>Tensorboard</a> </li> </ul> </li> <li class> <a href=../../advanced-optimization/ class>Optimization</a> </li> <li data-adress=sub-1 class=has-sub-side> <div href class="parent-list "> Secure Aggregation <i class="bi bi-chevron-down"></i> </div> <ul class="sub-sidebar-menu sub "> <li class> <a href=../../secagg/introduction/ class>Introduction</a> </li> <li class> <a href=../../secagg/configuration/ class>Configuration</a> </li> <li class> <a href=../../secagg/certificate-registration/ class>Certificate Registration</a> </li> <li class> <a href=../../secagg/researcher-interface/ class>Managing Secure Aggregation in Researcher</a> </li> </ul> </li> </ul> </li> <li data-adress=sub-1 class=has-sub-side> <div href class="parent-list "> Developer <i class="bi bi-chevron-down"></i> </div> <ul class="sub-sidebar-menu sub "> <li data-adress=sub-1 class=has-sub-side> <div href class="parent-list "> API Reference <i class="bi bi-chevron-down"></i> </div> <ul class="sub-sidebar-menu sub "> <li data-adress=sub-1 class=has-sub-side> <div href class="parent-list "> Common <i class="bi bi-chevron-down"></i> </div> <ul class="sub-sidebar-menu sub "> <li class> <a href=../../../developer/api/common/constants/ class>Constants</a> </li> <li class> <a href=../../../developer/api/common/data/ class>Data</a> </li> <li class> <a href=../../../developer/api/common/environ/ class>Environ</a> </li> <li class> <a href=../../../developer/api/common/exceptions/ class>Exceptions</a> </li> <li class> <a class href=../../../developer/api/common/json.md>Json</a> </li> <li class> <a href=../../../developer/api/common/logger/ class>Logger</a> </li> <li class> <a href=../../../developer/api/common/message/ class>Message</a> </li> <li class> <a class href=../../../developer/api/common/messaging.md>Messaging</a> </li> <li class> <a href=../../../developer/api/common/models/ class>Model</a> </li> <li class> <a href=../../../developer/api/common/optimizers/ class>Optimizers</a> </li> <li class> <a class href=../../../developer/api/common/repository.md>Repository</a> </li> <li class> <a href=../../../developer/api/common/tasks_queue/ class>TasksQueue</a> </li> <li class> <a href=../../../developer/api/common/training_plans/ class>TrainingPlans</a> </li> <li class> <a href=../../../developer/api/common/training_args/ class>TrainingArgs</a> </li> <li class> <a href=../../../developer/api/common/utils/ class>Utils</a> </li> <li class> <a href=../../../developer/api/common/validator/ class>Validator</a> </li> </ul> </li> <li data-adress=sub-1 class=has-sub-side> <div href class="parent-list "> Node <i class="bi bi-chevron-down"></i> </div> <ul class="sub-sidebar-menu sub "> <li class> <a href=../../../developer/api/node/cli/ class>CLI</a> </li> <li class> <a href=../../../developer/api/node/dataset_manager/ class>DatasetManager</a> </li> <li class> <a href=../../../developer/api/node/node/ class>Node</a> </li> <li class> <a href=../../../developer/api/node/node_state_manager/ class>NodeStateManager</a> </li> <li class> <a href=../../../developer/api/node/training_plan_security_manager/ class>TrainingPlanSecurityManager</a> </li> <li class> <a href=../../../developer/api/node/history_monitor/ class>HistoryMonitor</a> </li> <li class> <a href=../../../developer/api/node/round/ class>Round</a> </li> </ul> </li> <li data-adress=sub-1 class=has-sub-side> <div href class="parent-list "> Researcher <i class="bi bi-chevron-down"></i> </div> <ul class="sub-sidebar-menu sub "> <li class> <a href=../../../developer/api/researcher/aggregators/ class>Aggregators</a> </li> <li class> <a href=../../../developer/api/researcher/datasets/ class>Datasets</a> </li> <li class> <a href=../../../developer/api/researcher/experiment/ class>Experiment</a> </li> <li class> <a href=../../../developer/api/researcher/filetools/ class>Filetools</a> </li> <li class> <a href=../../../developer/api/researcher/job/ class>Job</a> </li> <li class> <a href=../../../developer/api/researcher/monitor/ class>Monitor</a> </li> <li class> <a href=../../../developer/api/researcher/node_state_agent/ class>NodeStateAgent</a> </li> <li class> <a href=../../../developer/api/researcher/requests/ class>Requests</a> </li> <li class> <a href=../../../developer/api/researcher/strategies/ class>Strategies</a> </li> <li class> <a href=../../../developer/api/researcher/secagg/ class>Secagg</a> </li> </ul> </li> </ul> </li> <li class> <a href=../../../developer/usage_and_tools/ class>Usage and Tools</a> </li> <li class> <a href=../../../developer/ci/ class>Continuous Integration</a> </li> <li class> <a href=../../../developer/definition-of-done/ class>Definition of Done</a> </li> <li class> <a href=../../../developer/testing-in-fedbiomed/ class>Testing in Fed-BioMed</a> </li> <li class> <a href=../../../developer/messaging/ class>RPC Protocol and Messages</a> </li> </ul> </li> </ul> </nav> </div> </div> <div class=main-col> <main class=main-docs> <article> <h1 id=parameter-aggregation-in-fed-biomed>Parameter Aggregation in Fed-BioMed</h1> <p>Aggregation of model parameters plays an important role in federated learning, where we naturally deal with data heterogeneity. Unlike the distributed learning datasets, model parameters are saved as same-sized data blocks for each node training the same model. The number of samples, the quality of the samples cand their data distribution can vary in every <code>Node</code>. In Fed-BioMed, we currently work on providing various solutions for this heterogeneity. Up to now, we support <a href=https://arxiv.org/abs/1602.05629><code>FedAverage</code></a> which performs the standard aggregation scheme in federated learning: federated averaging. We also provide <a href=https://arxiv.org/abs/1812.06127><code>FedProx</code></a> and <a href=https://arxiv.org/pdf/2207.06343.pdf><code>SCAFFOLD</code></a> aggregation methods.</p> <div class="admonition warning"> <p class=admonition-title>Important</p> <p>The following <code>Aggregators</code> can also be used with <code>declearn Optimizers</code>, providing advanced gradient-based optimization modules. These <code>Optimizers</code> are cross-framework, meaning it is possible to use it with all machine learning framework provided by Fed-BioMed. Please visit the webpage dedicated to <a href=../../advanced-optimization><em>advanced optimization</em></a>.</p> </div> <h2 id=fed-biomed-aggregators>Fed-BioMed <code>Aggregators</code>:</h2> <p>Fed-BioMed <code>Aggregators</code> are showcased in the following <a href=../tutorials/pytorch/05-aggregation-in-fed-biomed>tutorial</a>. </p> <h3 id=federated-averaging-fedaveraging>Federated Averaging (FedAveraging)</h3> <p><code>FedAveraging</code> is the default <code>Aggregator</code> in Fed-BioMed, introduced by <a href=https://arxiv.org/abs/1602.05629>McMahan et al.</a>. It performs a weighted mean of local model parameters based on the size of node specific datasets. This operation occurs after each round of training in the <code>Nodes</code>.</p> <div class=arithmatex>\[w_{t+1} := \sum_{k=1}^K\frac{n_k}{n}w_{t+1}^k\]</div> <p>where <span class=arithmatex>\( w_{t} \)</span> are the weights at round <span class=arithmatex>\(t\)</span>, <span class=arithmatex>\(K\)</span> is the number of <code>Nodes</code> participating at round <span class=arithmatex>\(t\)</span>, and <span class=arithmatex>\( n_k, n \)</span> are the number of samples of the <span class=arithmatex>\(k\)</span>-th node and of the total federation respectively. </p> <h3 id=fedprox>FedProx</h3> <p>Similar to <code>FedAveraging</code>, <a href=https://arxiv.org/abs/1812.06127><code>FedProx</code></a> performs a weighted sum of local model parameters. <code>FedProx</code> however introduces a regularization operation, using <span class=arithmatex>\(\mathcal{L}_2\)</span> norm, in order to tackle statistical heterogeneity. Basically, it reformulates the loss function by:</p> <div class=arithmatex>\[F_k(w) + \frac{\mu}{2}|| w - w^t ||^2_2\]</div> <p>using the same notation as above, with <span class=arithmatex>\(\mu\)</span> the regularization parameter (we obtain <code>FedAveraging</code> by setting <span class=arithmatex>\(\mu=0\)</span>) and <span class=arithmatex>\(F_k\)</span> the objective function.</p> <p>To use <code>FedProx</code>, use <code>FedAverage</code> from <code>fedbiomed.researcher.aggregators</code> and specify a value for <span class=arithmatex>\(\mu\)</span> in the training arguments <code>training_args</code> using the argument name <code>fedprox_mu</code>.</p> <h3 id=scaffold>SCAFFOLD</h3> <p><a href=https://arxiv.org/pdf/2207.06343.pdf><code>SCAFFOLD</code></a> stands for <em>Stochastic Controlled Averaging for Federated Learning</em>. It introduces a correction state parameter in order to tackle <em>the client drift</em>, depicting the fact that when data across each <code>Node</code> are heterogeneous, each of the <code>Nodes</code> pushes the model in a different direction in the optimization space and the global model does not converge towards the true optima. In Fed-BioMed, only <em>option 2</em> of the <code>SCAFFOLD</code> paper has been implemented. Additional details about the implementation can be found in the developer <a class="autorefs autorefs-internal" href="../../../developer/api/researcher/aggregators/#fedbiomed.researcher.aggregators.Scaffold">API reference</a>.</p> <p>The corrected loss function used to update the model is computed as follows:</p> <div class=arithmatex>\[F_k(w) + c \cdot w - c_k \cdot w\]</div> <p>where <span class=arithmatex>\(c_k\)</span> is the <code>Node</code> correction term, <span class=arithmatex>\(c = \frac{1}{K}\sum_{k=1}^K{c_k}\)</span> is the server's correction term,<br> and <span class=arithmatex>\(K\)</span> is the total number of participating <code>Nodes</code> as above. </p> <p>On the <code>Researcher</code> side, the global model is updated by performing gradient descent.</p> <p>Additional parameters are needed when working with <code>SCAFFOLD</code>: </p> <ul> <li><code>server_lr</code>: <code>Researcher</code>'s learning rate for performing a gradient step</li> <li><code>num_updates</code>: the number of updates (ie gradient descent optimizer steps) to be performed on each <code>Node</code>. Relying only on <code>epochs</code> could lead to some inconsistencies in the computation of the correction term: thus, in Fed-BioMed, <code>SCAFFOLD</code> aggregator cannot be used with <code>epochs</code>.</li> </ul> <p>Please note that:</p> <ul> <li><code>SCAFFOLD</code> should be used only with <code>SGD</code> optimizer. Using other <code>Optimizers</code> in Fed-BioMed is possible, but without any convergence guarantees.</li> <li><code>SCAFFOLD</code> can only be used with the <code>PyTorch</code> framework at the moment, and correction terms are not encrypted when exchanged (even when using SecAgg).</li> <li><code>SCAFFOLD</code> <strong>requires</strong> using the <code>num_updates</code> training argument to control the number of <a href=../experiment/#controlling-the-number-of-training-loop-iterations>training iterations</a>. Using only <code>epochs</code> will raise an error.</li> <li><code>SCAFFOLD</code> also exists as an <code>declearn</code> cross framework optimizer. Using <code>SCAFFOLD</code> implementation in <code>declearn</code> enables the use of other machine learning frameworks such as <code>scikit-learn</code>.</li> </ul> <h2 id=how-to-create-your-custom-aggregator>How to Create Your Custom Aggregator</h2> <h3 id=designing-your-own-aggregator-class-the-aggregation-method>Designing your own <code>Aggregator</code> class: the <code>aggregation</code> method</h3> <p>Before designing your custom aggregation algorithm we recommend you to see default <code>FedAverage</code> [aggregate method][fedbiomed.researcher.aggregators.fedavg.FedAverage.aggregate]</p> <p><code>aggregate</code> method is expecting at least <code>model_params</code> and <code>weights</code> arguments. Additional argument can be passed through <code>*args</code> and <code>kwargs</code> depending, on the values needed for your <code>Aggregator</code>.</p> <p>It is possible to create your custom aggregator by creating a new class which inherits from the Aggregator class defined in <code>fedbiomed.researcher.aggregators.aggregator.Aggregator</code>.</p> <div class=highlight><pre><span></span><code><span class=k>class</span> <span class=nc>Aggregator</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Defines methods for aggregating strategy</span>
<span class=sd>    (eg FedAvg, FedProx, SCAFFOLD, ...).</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>pass</span>

    <span class=nd>@staticmethod</span>
    <span class=k>def</span> <span class=nf>normalize_weights</span><span class=p>(</span><span class=n>weights</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>list</span><span class=p>:</span>
        <span class=c1># Load list of weights assigned to each node and</span>
        <span class=c1># normalize these weights so they sum up to 1</span>
        <span class=n>norm</span> <span class=o>=</span> <span class=p>[</span><span class=n>w</span><span class=o>/</span><span class=nb>sum</span><span class=p>(</span><span class=n>weights</span><span class=p>)</span> <span class=k>for</span> <span class=n>w</span> <span class=ow>in</span> <span class=n>weights</span><span class=p>]</span>
        <span class=k>return</span> <span class=n>norm</span>

    <span class=k>def</span> <span class=nf>aggregate</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span>  <span class=n>model_params</span><span class=p>:</span> <span class=nb>list</span><span class=p>,</span> <span class=n>weights</span><span class=p>:</span> <span class=nb>list</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>:</span> <span class=c1># pragma: no cover</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Strategy to aggregate models&quot;&quot;&quot;</span>
        <span class=k>pass</span>
</code></pre></div> <p>Your child class should extend the method <code>aggregate</code> that gets model parameters and weights as arguments. The model parameters are those which have been locally updated in each node during the last round. The weights represent the ratio of the number of samples in each node and the total number of samples. Your custom aggregator class should return aggregated parameters.</p> <p>You should also pay attention to the way the parameters are loaded. For example, it may be a dictionary that contains tensor data types or just an array. As you can see from the following example, the aggregator first checks the data type of the parameters, and then it does the averaging.</p> <div class=highlight><pre><span></span><code>    <span class=k>if</span> <span class=n>t</span> <span class=o>==</span> <span class=s1>&#39;tensor&#39;</span><span class=p>:</span>
        <span class=k>for</span> <span class=n>model</span><span class=p>,</span> <span class=n>weight</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>model_params</span><span class=p>,</span> <span class=n>proportions</span><span class=p>):</span>
            <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>avg_params</span><span class=o>.</span><span class=n>keys</span><span class=p>():</span>
                <span class=n>avg_params</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>+=</span> <span class=n>weight</span> <span class=o>*</span> <span class=n>model</span><span class=p>[</span><span class=n>key</span><span class=p>]</span>

    <span class=k>if</span> <span class=n>t</span> <span class=o>==</span> <span class=s1>&#39;array&#39;</span><span class=p>:</span>
        <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>avg_params</span><span class=o>.</span><span class=n>keys</span><span class=p>():</span>
            <span class=n>matr</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span> <span class=n>d</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=k>for</span> <span class=n>d</span> <span class=ow>in</span> <span class=n>model_params</span> <span class=p>])</span>
            <span class=n>avg_params</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>average</span><span class=p>(</span><span class=n>matr</span><span class=p>,</span><span class=n>weights</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>weights</span><span class=p>),</span><span class=n>axis</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</code></pre></div> <h3 id=desinging-your-own-aggregator-class-the-create_aggregator_args-method>Desinging your own <code>Aggregator</code> class: the <code>create_aggregator_args</code> method</h3> <p>For some advanced <code>Aggregators</code>, you may need to send some argument to <code>Nodes</code> in order to update the local model. For instance, <code>SCAFFOLD</code> <code>Aggregator</code> sends specific correction terms for each of the <code>Nodes</code> involved in the training. </p> <p>The method that has this responsability is <code>create_aggregator_args</code>, and is designed as follow (in the <code>fedbiomed.researcher.aggregators.aggregator.Aggregator</code> class):</p> <div class=highlight><pre><span></span><code><span class=k>def</span> <span class=nf>create_aggregator_args</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Tuple</span><span class=p>[</span><span class=nb>dict</span><span class=p>,</span> <span class=nb>dict</span><span class=p>]:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Returns aggregator arguments that are expecting by the nodes</span>

<span class=sd>    Returns:</span>
<span class=sd>    dict: contains `Aggregator` parameters that will be sent to nodes </span>
<span class=sd>    dict: contains parameters that will be sent through file exchange message.</span>
<span class=sd>            Both dictionaries are mapping node_id to `Aggregator` parameters specific </span>
<span class=sd>            to each Node.</span>

<span class=sd>    &quot;&quot;&quot;</span>
    <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_aggregator_args</span> <span class=ow>or</span> <span class=p>{},</span> <span class=p>{}</span>
</code></pre></div> <h2 id=conclusions>Conclusions</h2> <p>In this article, the aggregation process has been explained. Currently, Fed-BioMed only supports the vanilla federated averaging scheme for the aggregation operation called <code>FedAverage</code>, as well as <code>FedProx</code> and <code>SCAFFOLD</code>. However, Fed-BioMed also allows you to create your custom aggregator using the <code>Aggregator</code> parent class. It means that you can define your custom aggregator based on your use case(s). You can define it in your notebook or python script and passed into the <a href=../experiment/ >Experiment</a> as an argument.</p> </article> </main> </div> <div class=right-col> <div id=right-sidebar class=sidebar-right> <nav class=toc> <!-- Render item list --> <label class=toc-title for=__toc> <span class=toc-icon></span> </label> <ul class=toc-list data-md-component=toc data-md-scrollfix> <!-- Table of contents item --> <li class=toc-item> <a href=#fed-biomed-aggregators class=md-nav__link> Fed-BioMed Aggregators: </a> <nav class=toc-nav aria-label="Fed-BioMed Aggregators:"> <ul class=toc-list> <!-- Table of contents item --> <li class=toc-item> <a href=#federated-averaging-fedaveraging class=md-nav__link> Federated Averaging (FedAveraging) </a> </li> <!-- Table of contents item --> <li class=toc-item> <a href=#fedprox class=md-nav__link> FedProx </a> </li> <!-- Table of contents item --> <li class=toc-item> <a href=#scaffold class=md-nav__link> SCAFFOLD </a> </li> </ul> </nav> </li> <!-- Table of contents item --> <li class=toc-item> <a href=#how-to-create-your-custom-aggregator class=md-nav__link> How to Create Your Custom Aggregator </a> <nav class=toc-nav aria-label="How to Create Your Custom Aggregator"> <ul class=toc-list> <!-- Table of contents item --> <li class=toc-item> <a href=#designing-your-own-aggregator-class-the-aggregation-method class=md-nav__link> Designing your own Aggregator class: the aggregation method </a> </li> <!-- Table of contents item --> <li class=toc-item> <a href=#desinging-your-own-aggregator-class-the-create_aggregator_args-method class=md-nav__link> Desinging your own Aggregator class: the create_aggregator_args method </a> </li> </ul> </nav> </li> <!-- Table of contents item --> <li class=toc-item> <a href=#conclusions class=md-nav__link> Conclusions </a> </li> </ul> </nav> </div> </div> </div> </div> <!-- News Main Page--> </div> <footer> <div class=container-fluid> <div class=footer-first-inner> <div class=container> <div class=row> <div class=col-md-6> <div class=footer-contact> <strong>Address:</strong> <p>2004 Rte des Lucioles, 06902 Sophia Antipolis</p> <strong>E-mail:</strong> <p>fedbiomed _at_ inria _dot_ fr</p> </div> </div> <div class=col-md-6> <div class=footer-contact> <p>Fed-BioMed Â© 2022</p> </div> </div> </div> </div> </div> </div> </footer> <!-- JQuery --> <script src=https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js></script> <!-- Latest compiled and minified JavaScript --> <script src=https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js integrity=sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd crossorigin=anonymous></script> <script src=https://cdnjs.cloudflare.com/ajax/libs/tablesort/5.2.1/tablesort.min.js></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script> <script src=../../../assets/javascript/lunr.js></script> <script src=../../../assets/javascript/theme.js></script> </body> </html>
<!DOCTYPE html><html> <head><meta charset=UTF-8><meta name=viewport content="width=device-width, initial-scale=1"><meta name=robots context="index, archive"><!--  --><script>
      const versions_json = "../../../../versions.json";
      const search_worker_js = "../../../assets/javascript/search-worker.js";
      const search_index_json = "../../../search/search_index.json";
      const base_url = '../../..';
    </script><!-- Site title --><title>Model Validation on the Nodes in Federated Training - Fed-BioMed</title><link rel=icon type=image/x-icon href=../../../favicon.ico><!-- Page description --><meta name=description content="The validation part in FL plays an important role while evaluating model performance that is trained on different nodes with different datasets. Fed-BioMed provides a validation routine on the datasets that are randomly split at each round of training."><!-- Page keywords --><meta name=keywords content="validation in FL, Fed-BioMed model validation, validating model performance, test_batch_size"><!-- Page author --><!-- Latest compiled and minified CSS --><link rel=stylesheet href=https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css integrity=sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu crossorigin=anonymous><!-- Bootstrap Icons --><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css><link href=../../../assets/_mkdocstrings.css rel=stylesheet><link href=../../../assets/css/style.css rel=stylesheet></head> <body> <header> <div class="container-fluid top-bar"> <div class=brand> <a href=/ > <img src=../../../assets/img/fedbiomed-logo-small.png> </a> </div> <nav class=top> <ul> <li class> <a href=../../..>Home</a> </li> <li class> <a href=../../../getting-started/what-is-fedbiomed/ >User Documentation</a> </li> <li class> <a href=../../../pages/about-us/ >About</a> </li> <li id=clicker class=has-sub> More <i class="bi bi-chevron-down"></i> <ul class=sub-nav-menu> <li class> <a href=../../../#funding>Funding</a> </li> <li class> <a href=../../../news/ >News</a> </li> <li class> <a href=../../../#contributors>Contributors</a> </li> <li class> <a href=../../../#users>Users</a> </li> <li class> <a href=../../../pages/roadmap/ >Roadmap</a> </li> <li class> <a href=../../../#contact-us>Contact Us</a> </li> </ul> </li> </ul> </nav> </div> <div class="container-fluid top-bar-mobile"> <div class=mobile-bar> <div class=brand> <a href=../../../ > <img src=../../../assets/img/fedbiomed-logo-small.png> </a> </div> <div class=hum-menu> <img class=open src=../../../assets/img/menu.svg> <img class=close style=display:none src=../../../assets/img/cancel.svg> </div> </div> <nav class=top-mobile> <ul> <li class> <a href=../../..>Home</a> </li> <li class> <a href=../../../getting-started/what-is-fedbiomed/ >User Documentation</a> </li> <li class> <a href=../../../pages/about-us/ >About</a> </li> <li id=clicker class=has-sub> More <i class="bi bi-chevron-down"></i> <ul class=sub-nav-menu> <li class> <a href=../../../#funding>Funding</a> </li> <li class> <a href=../../../news/ >News</a> </li> <li class> <a href=../../../#contributors>Contributors</a> </li> <li class> <a href=../../../#users>Users</a> </li> <li class> <a href=../../../pages/roadmap/ >Roadmap</a> </li> <li class> <a href=../../../#contact-us>Contact Us</a> </li> </ul> </li> </ul> </nav> </div> </header> <div class=main> <!-- Home page --> <div class=container-fluid> <div class=doc-row> <div class=left-col> <div class=sidebar-doc> <nav class=sidebar-inner> <ul class="sidebar-menu-left sub"> <li data-adress=sub-1 class=has-sub-side> <div href class="parent-list "> Getting Started <i class="bi bi-chevron-down"></i> </div> <ul class="sub-sidebar-menu sub "> <li class> <a href=../../../getting-started/what-is-fedbiomed/ class>What's Fed-BioMed</a> </li> <li class> <a href=../../../getting-started/getting-started/ class>Basic Example</a> </li> <li class> <a href=../../../getting-started/fedbiomed-architecture/ class>Fedbiomed Architecture</a> </li> <li class> <a href=../../../getting-started/fedbiomed-workflow/ class>Fedbiomed Workflow</a> </li> </ul> </li> <li data-adress=sub-1 class=has-sub-side> <div href class="parent-list "> Tutorials <i class="bi bi-chevron-down"></i> </div> <ul class="sub-sidebar-menu sub "> <li data-adress=sub-1 class=has-sub-side> <div href class="parent-list "> Installation <i class="bi bi-chevron-down"></i> </div> <ul class="sub-sidebar-menu sub "> <li class> <a href=../../../tutorials/installation/0-basic-software-installation/ class>Software Installation</a> </li> <li class> <a href=../../../tutorials/installation/1-setting-up-environment/ class>Setting Up Environment</a> </li> </ul> </li> <li data-adress=sub-1 class=has-sub-side> <div href class="parent-list "> PyTorch <i class="bi bi-chevron-down"></i> </div> <ul class="sub-sidebar-menu sub "> <li class> <a href=../../../tutorials/pytorch/01_PyTorch_MNIST_Single_Node_Tutorial/ class>PyTorch MNIST Basic Example</a> </li> <li class> <a href=../../../tutorials/pytorch/02_Create_Your_Custom_Training_Plan/ class>How to Create Your Custom PyTorch Training Plan</a> </li> <li class> <a href=../../../tutorials/pytorch/03_PyTorch_Used_Cars_Dataset_Example/ class>PyTorch Used Cars Dataset Example</a> </li> <li class> <a href=../../../tutorials/pytorch/04-Aggregation_in_Fed-BioMed/ class>PyTorch aggregation methods in Fed-BioMed</a> </li> <li class> <a href=../../../tutorials/pytorch/05_Transfer-learning_tutorial_usingDenseNet-121/ class>Transfer-learning in Fed-BioMed tutorial</a> </li> </ul> </li> <li data-adress=sub-1 class=has-sub-side> <div href class="parent-list "> MONAI <i class="bi bi-chevron-down"></i> </div> <ul class="sub-sidebar-menu sub "> <li class> <a href=../../../tutorials/monai/01_monai-2d-image-classification/ class>Federated 2d image classification with MONAI</a> </li> <li class> <a href=../../../tutorials/monai/02_monai-2d-image-registration/ class>Federated 2d XRay registration with MONAI</a> </li> </ul> </li> <li data-adress=sub-1 class=has-sub-side> <div href class="parent-list "> Scikit-Learn <i class="bi bi-chevron-down"></i> </div> <ul class="sub-sidebar-menu sub "> <li class> <a href=../../../tutorials/scikit-learn/01_sklearn_MNIST_classification_tutorial/ class>MNIST classification with Scikit-Learn Classifier (Perceptron)</a> </li> <li class> <a href=../../../tutorials/scikit-learn/02_sklearn_sgd_regressor_tutorial/ class>Fed-BioMed to train a federated SGD regressor model</a> </li> <li class> <a href=../../../tutorials/scikit-learn/03-other-scikit-learn-models/ class>Implementing other Scikit Learn models for Federated Learning</a> </li> </ul> </li> <li data-adress=sub-1 class=has-sub-side> <div href class="parent-list "> Optimizers <i class="bi bi-chevron-down"></i> </div> <ul class="sub-sidebar-menu sub "> <li class> <a href=../../../tutorials/optimizers/01-fedopt-and-scaffold/ class>Advanced optimizers in Fed-BioMed</a> </li> </ul> </li> <li data-adress=sub-1 class=has-sub-side> <div href class="parent-list "> FLamby <i class="bi bi-chevron-down"></i> </div> <ul class="sub-sidebar-menu sub "> <li class> <a href=../../../tutorials/flamby/flamby/ class>General Concepts</a> </li> <li class> <a href=../../../tutorials/flamby/flamby-integration-into-fedbiomed/ class>FLamby integration in Fed-BioMed</a> </li> </ul> </li> <li data-adress=sub-1 class=has-sub-side> <div href class="parent-list "> Advanced <i class="bi bi-chevron-down"></i> </div> <ul class="sub-sidebar-menu sub "> <li class> <a href=../../../tutorials/advanced/in-depth-experiment-configuration/ class>In Depth Experiment Configuration</a> </li> <li class> <a href=../../../tutorials/advanced/training-with-gpu/ class>PyTorch model training using a GPU</a> </li> <li class> <a href=../../../tutorials/advanced/breakpoints/ class>Breakpoints</a> </li> </ul> </li> <li data-adress=sub-1 class=has-sub-side> <div href class="parent-list "> Security <i class="bi bi-chevron-down"></i> </div> <ul class="sub-sidebar-menu sub "> <li class> <a href=../../../tutorials/security/differential-privacy-with-opacus-on-fedbiomed/ class>Using Differential Privacy with OPACUS on Fed-BioMed</a> </li> <li class> <a href=../../../tutorials/security/non-private-local-central-dp-monai-2d-image-registration/ class>Local and Central DP with Fed-BioMed: MONAI 2d image registration</a> </li> <li class> <a href=../../../tutorials/security/training-with-approved-training-plans/ class>Training Process with Training Plan Management</a> </li> <li class> <a href=../../../tutorials/security/secure-aggregation/ class>Training with Secure Aggregation</a> </li> <li class> <a href=../../../tutorials/concrete-ml/concrete-ml/ class>End-to-end Privacy Preserving Training and Inference on Medical Data</a> </li> </ul> </li> <li data-adress=sub-1 class=has-sub-side> <div href class="parent-list "> Biomedical data <i class="bi bi-chevron-down"></i> </div> <ul class="sub-sidebar-menu sub "> <li class> <a href=../../../tutorials/medical/medical-image-segmentation-unet-library/ class>Brain Segmentation</a> </li> </ul> </li> </ul> </li> <li data-adress=sub-1 class="current has-sub-side"> <div href class="parent-list current "> User Guide <i class="bi bi-chevron-down"></i> </div> <ul class="sub-sidebar-menu sub active "> <li class> <a href=../../glossary/ class>Glossary</a> </li> <li data-adress=sub-1 class=has-sub-side> <div href class="parent-list "> Deployment <i class="bi bi-chevron-down"></i> </div> <ul class="sub-sidebar-menu sub "> <li class> <a href=../../deployment/deployment/ class>Introduction</a> </li> <li class> <a href=../../deployment/deployment-vpn/ class>VPN Deployment</a> </li> <li class> <a href=../../deployment/matrix/ class>Network matrix</a> </li> <li class> <a href=../../deployment/security-model/ class>Security model</a> </li> </ul> </li> <li data-adress=sub-1 class=has-sub-side> <div href class="parent-list "> Node <i class="bi bi-chevron-down"></i> </div> <ul class="sub-sidebar-menu sub "> <li class> <a href=../../nodes/configuring-nodes/ class>Configuring Nodes</a> </li> <li class> <a href=../../nodes/deploying-datasets/ class>Deploying Datasets</a> </li> <li class> <a href=../../nodes/training-plan-security-manager/ class>Training Plan Management</a> </li> <li class> <a href=../../nodes/using-gpu/ class>Using GPU</a> </li> <li class> <a href=../../nodes/node-gui/ class>Node GUI</a> </li> </ul> </li> <li data-adress=sub-1 class="current has-sub-side"> <div href class="parent-list current "> Researcher <i class="bi bi-chevron-down"></i> </div> <ul class="sub-sidebar-menu sub active "> <li class> <a href=../training-plan/ class>Training Plan</a> </li> <li class> <a href=../training-data/ class>Training Data</a> </li> <li class> <a href=../experiment/ class>Experiment</a> </li> <li class> <a href=../aggregation/ class>Aggregation</a> </li> <li class> <a href=../listing-datasets-and-selecting-nodes/ class>Listing Datasets and Selecting Nodes</a> </li> <li class=current> <a href=./ class="link current">Model Validation on the Node Side</a> </li> <li class> <a href=../tensorboard/ class>Tensorboard</a> </li> </ul> </li> <li class> <a href=../../advanced-optimization/ class>Optimization</a> </li> <li data-adress=sub-1 class=has-sub-side> <div href class="parent-list "> Secure Aggregation <i class="bi bi-chevron-down"></i> </div> <ul class="sub-sidebar-menu sub "> <li class> <a href=../../secagg/introduction/ class>Introduction</a> </li> <li class> <a href=../../secagg/configuration/ class>Configuration</a> </li> <li class> <a href=../../secagg/researcher-interface/ class>Managing Secure Aggregation in Researcher</a> </li> </ul> </li> </ul> </li> <li data-adress=sub-1 class=has-sub-side> <div href class="parent-list "> Developer <i class="bi bi-chevron-down"></i> </div> <ul class="sub-sidebar-menu sub "> <li data-adress=sub-1 class=has-sub-side> <div href class="parent-list "> API Reference <i class="bi bi-chevron-down"></i> </div> <ul class="sub-sidebar-menu sub "> <li data-adress=sub-1 class=has-sub-side> <div href class="parent-list "> Common <i class="bi bi-chevron-down"></i> </div> <ul class="sub-sidebar-menu sub "> <li class> <a href=../../../developer/api/common/certificate_manager/ class>Certificate Manager</a> </li> <li class> <a href=../../../developer/api/common/cli/ class>CLI</a> </li> <li class> <a href=../../../developer/api/common/config/ class>Config</a> </li> <li class> <a href=../../../developer/api/common/constants/ class>Constants</a> </li> <li class> <a href=../../../developer/api/common/data/ class>Data</a> </li> <li class> <a href=../../../developer/api/common/db/ class>DB</a> </li> <li class> <a href=../../../developer/api/common/environ/ class>Environ</a> </li> <li class> <a href=../../../developer/api/common/exceptions/ class>Exceptions</a> </li> <li class> <a href=../../../developer/api/common/ipython/ class>IPython</a> </li> <li class> <a href=../../../developer/api/common/json/ class>Json</a> </li> <li class> <a href=../../../developer/api/common/logger/ class>Logger</a> </li> <li class> <a href=../../../developer/api/common/message/ class>Message</a> </li> <li class> <a href=../../../developer/api/common/metrics/ class>Metrics</a> </li> <li class> <a href=../../../developer/api/common/models/ class>Model</a> </li> <li class> <a class href=../../../developer/api/common/mpc_controller.md>MPC controller</a> </li> <li class> <a href=../../../developer/api/common/optimizers/ class>Optimizers</a> </li> <li class> <a href=../../../developer/api/common/privacy/ class>Privacy</a> </li> <li class> <a href=../../../developer/api/common/secagg/ class>Secagg</a> </li> <li class> <a href=../../../developer/api/common/secagg_manager/ class>Secagg Manager</a> </li> <li class> <a href=../../../developer/api/common/serializer/ class>Serializer</a> </li> <li class> <a href=../../../developer/api/common/singleton/ class>Singleton</a> </li> <li class> <a href=../../../developer/api/common/synchro/ class>Synchro</a> </li> <li class> <a href=../../../developer/api/common/tasks_queue/ class>TasksQueue</a> </li> <li class> <a href=../../../developer/api/common/training_plans/ class>TrainingPlans</a> </li> <li class> <a href=../../../developer/api/common/training_args/ class>TrainingArgs</a> </li> <li class> <a href=../../../developer/api/common/utils/ class>Utils</a> </li> <li class> <a href=../../../developer/api/common/validator/ class>Validator</a> </li> </ul> </li> <li data-adress=sub-1 class=has-sub-side> <div href class="parent-list "> Node <i class="bi bi-chevron-down"></i> </div> <ul class="sub-sidebar-menu sub "> <li class> <a href=../../../developer/api/node/cli/ class>CLI</a> </li> <li class> <a href=../../../developer/api/node/cli_utils/ class>CLI Utils</a> </li> <li class> <a href=../../../developer/api/node/config/ class>Config</a> </li> <li class> <a href=../../../developer/api/node/dataset_manager/ class>DatasetManager</a> </li> <li class> <a href=../../../developer/api/node/environ/ class>Environ</a> </li> <li class> <a href=../../../developer/api/node/history_monitor/ class>HistoryMonitor</a> </li> <li class> <a href=../../../developer/api/node/node/ class>Node</a> </li> <li class> <a href=../../../developer/api/node/node_state_manager/ class>NodeStateManager</a> </li> <li class> <a href=../../../developer/api/node/requests/ class>Requests</a> </li> <li class> <a href=../../../developer/api/node/round/ class>Round</a> </li> <li class> <a href=../../../developer/api/node/secagg/ class>Secagg</a> </li> <li class> <a href=../../../developer/api/node/secagg_manager/ class>Secagg Manager</a> </li> <li class> <a href=../../../developer/api/node/training_plan_security_manager/ class>TrainingPlanSecurityManager</a> </li> </ul> </li> <li data-adress=sub-1 class=has-sub-side> <div href class="parent-list "> Researcher <i class="bi bi-chevron-down"></i> </div> <ul class="sub-sidebar-menu sub "> <li class> <a href=../../../developer/api/researcher/aggregators/ class>Aggregators</a> </li> <li class> <a href=../../../developer/api/researcher/cli/ class>CLI</a> </li> <li class> <a href=../../../developer/api/researcher/config/ class>Config</a> </li> <li class> <a href=../../../developer/api/researcher/datasets/ class>Datasets</a> </li> <li class> <a href=../../../developer/api/researcher/environ/ class>Environ</a> </li> <li class> <a href=../../../developer/api/researcher/federated_workflows/ class>Federated Workflows</a> </li> <li class> <a href=../../../developer/api/researcher/filetools/ class>Filetools</a> </li> <li class> <a href=../../../developer/api/researcher/jobs/ class>Jobs</a> </li> <li class> <a href=../../../developer/api/researcher/monitor/ class>Monitor</a> </li> <li class> <a href=../../../developer/api/researcher/node_state_agent/ class>NodeStateAgent</a> </li> <li class> <a href=../../../developer/api/researcher/requests/ class>Requests</a> </li> <li class> <a href=../../../developer/api/researcher/secagg/ class>Secagg</a> </li> <li class> <a href=../../../developer/api/researcher/strategies/ class>Strategies</a> </li> </ul> </li> <li data-adress=sub-1 class=has-sub-side> <div href class="parent-list "> Transport <i class="bi bi-chevron-down"></i> </div> <ul class="sub-sidebar-menu sub "> <li class> <a href=../../../developer/api/transport/client/ class>Client</a> </li> <li class> <a href=../../../developer/api/transport/controller/ class>Controller</a> </li> <li class> <a href=../../../developer/api/transport/node_agent/ class>NodeAgent</a> </li> <li class> <a href=../../../developer/api/transport/server/ class>Server</a> </li> </ul> </li> </ul> </li> <li class> <a href=../../../developer/usage_and_tools/ class>Usage and Tools</a> </li> <li class> <a href=../../../developer/ci/ class>Continuous Integration</a> </li> <li class> <a href=../../../developer/definition-of-done/ class>Definition of Done</a> </li> <li class> <a href=../../../developer/testing-in-fedbiomed/ class>Testing in Fed-BioMed</a> </li> <li class> <a href=../../../developer/messaging/ class>RPC Protocol and Messages</a> </li> </ul> </li> </ul> </nav> </div> </div> <div class=main-col> <main class=main-docs> <article> <h1 id=model-validation-during-federated-training-on-the-nodes>Model Validation During Federated Training on the Nodes</h1> <p>Model validation is critical to discover how the model performs during the training rounds, when no dedicated holdout dataset is available for testing. In federated training, models are refined on the different nodes with different datasets. Therefore, model validation should be implemented on each node separately to compare model performances after its parameters are updated. Fed-BioMed provides a validation routine on the datasets that are randomly split at each round of training.</p> <p>In the federated learning concept, two validation types can be applied at each round of training:</p> <ul> <li>Validation on globally updated parameters (<code>test_on_global_updates</code>): It is the validation applied on the aggregated parameters before performing the training for the current round on a node.</li> <li>Validation on locally updated parameters (<code>test_on_local_updates</code>): It is the validation applied after the local training for the current round is performed on a node, and model parameters have been locally updated.</li> </ul> <p>These two validations allow the users to compare how training on the node has improved the model performance.</p> <div class="admonition warning"> <p class=admonition-title>Validation on the node side shouldn't be confused with the model <strong>testing</strong></p> <p>Currently, nodes do not provide completely separated datasets for validating model performance. Since the samples for validation and training are picked randomly at each round of training, the same samples could be used for training in one round and for validation in another round. It is assumed that the testing should be done by the user using a local dataset that contains samples that are not used for the training.</p> </div> <p>Figure 1 illustrates the phases of validation and training during 2 rounds of federated training. As it can be seen in the figure, after the last round of training, one last validation on global updates is performed on the last aggregated parameters by each node. Therefore, the number of validation on globally updated parameters, if it is activated, will be equal to the number of rounds + 1</p> <p><img alt=model-testing-during-training src=../../../assets/img/ModelTestingDuringTraining.jpg#img-centered-lr> <em>Figure 1 - Validation on global and local updates</em></p> <h2 id=default-metrics-provided-by-fed-biomed>Default Metrics Provided by Fed-BioMed</h2> <p>Fed-BioMed provides several test metrics to perform validation that can be used without defining a validation function in the training plan. It allows the user to launch an experiment by providing as less code as possible. You can display all the metric provided by Fed-BioMed as shown in the following code snippet.</p> <div class=highlight><pre><span></span><code><span class=kn>from</span><span class=w> </span><span class=nn>fedbiomed.common.metrics</span><span class=w> </span><span class=kn>import</span> <span class=n>MetricTypes</span>
<span class=n>MetricTypes</span><span class=o>.</span><span class=n>get_all_metrics</span><span class=p>()</span>

<span class=c1># &gt; Output:</span>
<span class=c1># &gt; [&#39;ACCURACY&#39;, &#39;F1_SCORE&#39;, &#39;PRECISION&#39;, &#39;RECALL&#39;,</span>
<span class=c1># &gt; &#39;MEAN_SQUARE_ERROR&#39;, &#39;MEAN_ABSOLUTE_ERROR&#39;,</span>
<span class=c1># &gt; &#39;EXPLAINED_VARIANCE&#39;]</span>
</code></pre></div> <div class="admonition note"> <p class=admonition-title>Note</p> <p>By default, <code>ACCURACY</code> metric is used as a test metric if there isn't a metric defined by the researcher. Therefore, please pay attention to whether <code>ACCURACY</code> is relevant for the model that is going to be trained. Otherwise, metric results might be inconsistent.</p> </div> <h2 id=validation-arguments>Validation Arguments</h2> <p>Validation during the training is an optional process, and validation arguments should be configured in order to activate it. Here is the list of validation arguments that can be configured.</p> <ul> <li><code>test_ratio</code>: Ratio of the validation partition of the dataset. The remaining samples will be used for training. By default, it is <code>0.0</code>.</li> <li><code>test_on_global_updates</code>: Boolean value that indicates whether validation will be applied to globally updated (aggregated) parameters (see Figure 1). Default is <code>False</code></li> <li><code>test_on_local_updates</code>: Boolean value that indicates whether validation will be applied to locally updated (trained) parameters (see Figure 1). Default is <code>False</code></li> <li><code>test_metric</code>: One of <code>MetricTypes</code> that indicates which metric will be used for validation. It can be <code>str</code> or an instance of <code>MetricTypes</code> (e.g. <code>MetricTypes.RECALL</code> or <code>RECALL</code> ). If it is <code>None</code> and there isn't <code>testing_step</code> defined in the training plan (see section: Define Custom Validation Step) default metric will be <code>ACCURACY</code>.</li> <li><code>test_metric_args</code>: A dictionary that contains the arguments that will be used for the metric function.</li> <li><code>test_batch_size</code>: A value used to compute metrics using batches instead of loading the full testing dataset (specified by <code>test_ratio</code>). Setting <code>test_batch_size</code> can avoid having <a href=https://docs.python.org/3/library/exceptions.html#MemoryError><code>MemoryError</code></a> errors due to large and /or heavy datasets. You should select wisely the batch size and the metric, for some metrics can be meaningless if computed over several small batches of data (e.g. explained variance). <code>test_batch_size</code> should be greater or equal than <code>1</code> (enabled) or equal to <code>0</code> or <code>None</code> (disabled).</li> </ul> <div class="admonition info"> <p class=admonition-title>Info</p> <p>Validation functions for each default metric executes functions from scikit-learn framework. Therefore, <code>test_metric_args</code> should be coherent with the arguments of "scikit-learn" metrics functions. Please visit <a href=https://scikit-learn.org/stable/modules/classes.html#module-sklearn.metrics>here</a> to see API documentation of scikit-learn metrics.</p> </div> <p>To activate validation on the node side, the arguments <code>test_ratio</code> and at least one of <code>test_on_local_updates</code> or <code>test_on_global_updates</code> should be set to <code>True</code>. Since the default values of <code>test_on_local_updates</code> and <code>test_on_global_updates</code> are <code>False</code>, setting <code>test_ratio</code> will only split dataset as validation and train sets but won't perform validation.</p> <h3 id=setting-validation-arguments-in-training-arguments>Setting Validation Arguments in Training Arguments</h3> <p>Validation arguments are considered a part of the training on the node side. Therefore, it is possible to define validation arguments in the training arguments and pass them to the experiment.</p> <div class=highlight><pre><span></span><code><span class=kn>from</span><span class=w> </span><span class=nn>fedbiomed.common.metrics</span><span class=w> </span><span class=kn>import</span> <span class=n>MetricTypes</span>
<span class=kn>from</span><span class=w> </span><span class=nn>fedbiomed.researcher.federated_workflows</span><span class=w> </span><span class=kn>import</span> <span class=n>Experiment</span>
<span class=n>training_args</span> <span class=o>=</span> <span class=p>{</span>
    <span class=c1>#....</span>
    <span class=s1>&#39;optimizer_args&#39;</span><span class=p>:</span> <span class=p>{</span>
        <span class=s1>&#39;lr&#39;</span><span class=p>:</span> <span class=mf>1e-3</span>
    <span class=p>},</span>
    <span class=s1>&#39;epochs&#39;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span>
    <span class=s1>&#39;batch_maxnum&#39;</span><span class=p>:</span> <span class=mi>100</span><span class=p>,</span>
    <span class=c1>#...</span>
    <span class=s1>&#39;test_ratio&#39;</span> <span class=p>:</span> <span class=mf>0.25</span><span class=p>,</span>
    <span class=s1>&#39;test_metric&#39;</span><span class=p>:</span> <span class=n>MetricTypes</span><span class=o>.</span><span class=n>F1_SCORE</span><span class=p>,</span>
    <span class=s1>&#39;test_on_global_updates&#39;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span>
    <span class=s1>&#39;test_on_local_updates&#39;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span>
    <span class=s1>&#39;test_batch_size&#39;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
    <span class=s1>&#39;test_metric_args&#39;</span><span class=p>:</span> <span class=p>{</span><span class=s1>&#39;average&#39;</span><span class=p>:</span> <span class=s1>&#39;macro&#39;</span><span class=p>}</span>
<span class=p>}</span>

<span class=n>exp</span> <span class=o>=</span> <span class=n>Experiment</span><span class=p>(</span><span class=c1># ....</span>
                 <span class=n>training_args</span><span class=o>=</span><span class=n>training_args</span><span class=p>)</span>
</code></pre></div> <h3 id=setting-validation-arguments-using-setters-of-the-experiment-class>Setting Validation Arguments using Setters of the Experiment Class</h3> <p>Each validation argument has its own setter method in the experiment class where federated training is managed. Therefore, validation arguments can be set, modified, or reset using the setters. To enable setters for validation arguments, the experiment should be created in advance.</p> <div class=highlight><pre><span></span><code><span class=kn>from</span><span class=w> </span><span class=nn>fedbiomed.common.metrics</span><span class=w> </span><span class=kn>import</span> <span class=n>MetricTypes</span>
<span class=kn>from</span><span class=w> </span><span class=nn>fedbiomed.researcher.federated_workflows</span><span class=w> </span><span class=kn>import</span> <span class=n>Experiment</span>

<span class=n>training_args</span> <span class=o>=</span> <span class=p>{</span>
    <span class=s1>&#39;optimizer_args&#39;</span><span class=p>:</span> <span class=p>{</span>
        <span class=s1>&#39;lr&#39;</span><span class=p>:</span> <span class=mf>1e-3</span><span class=p>,</span>
    <span class=p>},</span>
    <span class=s1>&#39;epochs&#39;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span>
    <span class=s1>&#39;batch_maxnum&#39;</span><span class=p>:</span> <span class=mi>100</span><span class=p>,</span>
    <span class=s1>&#39;test_batch_size&#39;</span><span class=p>:</span> <span class=mi>0</span>
<span class=p>}</span>
<span class=n>exp</span> <span class=o>=</span> <span class=n>Experiment</span><span class=p>(</span><span class=n>training_args</span><span class=o>=</span><span class=n>training_args</span><span class=p>)</span>

<span class=n>exp</span><span class=o>.</span><span class=n>set_test_ratio</span><span class=p>(</span><span class=mf>0.25</span><span class=p>)</span>
<span class=n>exp</span><span class=o>.</span><span class=n>set_test_on_local_updates</span><span class=p>(</span><span class=kc>True</span><span class=p>)</span>
<span class=n>exp</span><span class=o>.</span><span class=n>set_test_on_global_updates</span><span class=p>(</span><span class=kc>True</span><span class=p>)</span>
<span class=n>exp</span><span class=o>.</span><span class=n>set_test_metric</span><span class=p>(</span><span class=n>MetricTypes</span><span class=o>.</span><span class=n>F1_SCORE</span><span class=p>)</span> <span class=c1># or exp.set_test_metric(&#39;F1_SCORE&#39;)</span>
<span class=n>exp</span><span class=o>.</span><span class=n>set_test_metric_args</span><span class=p>({</span><span class=s1>&#39;average&#39;</span><span class=p>:</span> <span class=s1>&#39;macro&#39;</span><span class=p>})</span>
</code></pre></div> <p>Setters allow updating validation arguments from one round to others.</p> <div class=highlight><pre><span></span><code><span class=n>exp</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>rounds</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>increase</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
<span class=n>exp</span><span class=o>.</span><span class=n>set_test_ratio</span><span class=p>(</span><span class=mf>0.35</span><span class=p>)</span>
<span class=n>exp</span><span class=o>.</span><span class=n>set_set_test_metric</span><span class=p>(</span><span class=n>MetricTypes</span><span class=o>.</span><span class=n>ACCURACY</span><span class=p>)</span>
<span class=n>exp</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>rounds</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>increase</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</code></pre></div> <h2 id=using-validation-facility-with-heavy-datasets>Using Validation facility with heavy datasets</h2> <p>In some specific cases, you may have some very huge datain your datasets, such as 3D images, or you want a huge validation set, that you can load on <code>Node</code>s only through batches, in order to avoid <code>Nodes</code> to crash due to lack of Memory. <code>Fed-BioMed</code> provides an option to compute validation metrics through batches, in the <code>TrainingArgument</code>: <code>test_batch_size</code>.</p> <p>Validation will be computed over batches instead of computing metric using the whole dataset (which is the default behaviour) if <code>test_batch_size</code> is set. For now, <code>Fed-BioMed</code> does not provide a way to reconcile all these metrics under one metric (such as computing the mean of Accuracy for instance). If you want to do so, please consider defining your own <code>Validation step</code> by writing your own <code>testing_step</code> method in the <code>TrainingPlan</code> (see below for further details).</p> <div class=highlight><pre><span></span><code><span class=n>training_args</span> <span class=o>=</span> <span class=p>{</span>
    <span class=s1>&#39;optimizer_args&#39;</span><span class=p>:</span> <span class=p>{</span>
        <span class=s1>&#39;lr&#39;</span><span class=p>:</span> <span class=mf>1e-3</span><span class=p>,</span>
    <span class=p>},</span>
    <span class=s1>&#39;epochs&#39;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span>
    <span class=s1>&#39;test_ratio&#39;</span><span class=p>:</span> <span class=mf>.4</span><span class=p>,</span>
    <span class=s1>&#39;test_batch_size&#39;</span><span class=p>:</span> <span class=mi>64</span>  <span class=c1># validation metrics will be done by considering batches of size 64 each</span>
<span class=p>}</span>
<span class=n>exp</span> <span class=o>=</span> <span class=n>Experiment</span><span class=p>(</span><span class=n>training_args</span><span class=o>=</span><span class=n>training_args</span><span class=p>)</span>
</code></pre></div> <h2 id=define-custom-validation-step>Define Custom Validation Step</h2> <p>Fed-BioMed training plans allow defining custom validation steps for model evaluation on the node side. The name of the method that should be defined in the training plan is <code>testing_step</code>. It should take two input arguments as data/inputs and target/actual that are provided on the node side. The validation step can calculate and return multiple testing metrics as long as the return value of the method is supported. The method should return:</p> <ul> <li>Single <code>float</code> or <code>int</code> value that represents a single validation result. The name of the metric will be displayed as <code>Custom</code>.</li> </ul> <div class=highlight><pre><span></span><code><span class=k>def</span><span class=w> </span><span class=nf>testing_step</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>target</span><span class=p>):</span>
    <span class=c1># Validation actions ...</span>
    <span class=n>value</span> <span class=o>=</span> <span class=mf>1.001</span>

    <span class=k>return</span> <span class=n>value</span>
</code></pre></div> <ul> <li>List of multiple validation results. Metrics names will be displayed as <code>Custom_1</code>, <code>Custom_2</code>, <code>Custom_n</code> .</li> </ul> <div class=highlight><pre><span></span><code><span class=k>def</span><span class=w> </span><span class=nf>testing_step</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>target</span><span class=p>):</span>
    <span class=c1># Validation actions ...</span>
    <span class=n>value_1</span> <span class=o>=</span> <span class=mf>1.001</span>
    <span class=n>value_2</span> <span class=o>=</span> <span class=mf>1.002</span>
    <span class=k>return</span> <span class=p>[</span><span class=n>value_1</span><span class=p>,</span> <span class=n>value_2</span><span class=p>]</span>
</code></pre></div> <ul> <li>Dictionary of multiple metric results as <code>int</code> or <code>float</code>. Metrics names will be displayed as the keys of dictionary.</li> </ul> <div class=highlight><pre><span></span><code><span class=k>def</span><span class=w> </span><span class=nf>testing_step</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>target</span><span class=p>):</span>
    <span class=c1># Validation actions ...</span>
    <span class=n>result</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;metric-1&#39;</span> <span class=p>:</span> <span class=mf>0.01</span><span class=p>,</span> <span class=s1>&#39;metric-2&#39;</span><span class=p>:</span> <span class=mf>0.02</span><span class=p>}</span>
    <span class=k>return</span> <span class=n>result</span>
</code></pre></div> <div class="admonition info"> <p class=admonition-title>Info</p> <p><code>testing_step</code> has a higher priority than default test metrics. It means that if both <code>testing_step</code> in training plan and <code>test_metric</code><code>argument in the validation arguments are defined, node will only execute the method</code>testing_step`</p> </div> <p>The modules, functions, and methods that are going to be used in the validation method should be added as dependencies in the training plan (see <a href=#pytorch>PyTorch</a> and <a href=#sklearn>Sklearn</a>). Please also make sure that the modules whose functions will be used in the validation step do exist in the Fed-BioMed node environment.</p> <h3 id=pytorch>PyTorch</h3> <p>The validation method in PyTorch-based training plans takes two arguments respectively for input (<code>X</code>) and target (<code>y</code>). These arguments are instances of <code>torch.Tensor</code>. The validation mode of PyTorch will be already activated on the node side before running <code>testing_step</code> with <code>self.eval()</code>. Therefore, there is no need to configure it again in the validation step method.</p> <p>The following code snippet shows an example <code>testing_step</code> that calculates negative log-likelihood, cross-entropy and accuracy.</p> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>torch</span>
<span class=kn>from</span><span class=w> </span><span class=nn>fedbiomed.common.training_plans</span><span class=w> </span><span class=kn>import</span> <span class=n>TorchTrainingPlan</span>

<span class=k>class</span><span class=w> </span><span class=nc>MyTrainingPlan</span><span class=p>(</span><span class=n>TorchTrainingPlan</span><span class=p>):</span>

    <span class=c1># Other necessary methods e.g. `def init_model`</span>
    <span class=c1># .......</span>

    <span class=k>def</span><span class=w> </span><span class=nf>testing_step</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>target</span><span class=p>):</span>

        <span class=n>pred</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>model</span><span class=p>()</span><span class=o>.</span><span class=n>forward</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
        <span class=n>nll</span>   <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>nn</span><span class=o>.</span><span class=n>functional</span><span class=o>.</span><span class=n>nll_loss</span><span class=p>(</span><span class=n>pred</span><span class=p>,</span> <span class=n>target</span><span class=p>)</span>  <span class=c1># negative log likelihood loss</span>
        <span class=n>ce</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>nn</span><span class=o>.</span><span class=n>functional</span><span class=o>.</span><span class=n>cross_entropy</span><span class=p>(</span><span class=n>pred</span><span class=p>,</span><span class=n>target</span><span class=p>)</span> <span class=c1># cross entropy</span>


        <span class=n>_</span><span class=p>,</span> <span class=n>predicted</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>max</span><span class=p>(</span><span class=n>pred</span><span class=o>.</span><span class=n>data</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span>
        <span class=n>acc</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>sum</span><span class=p>(</span><span class=n>predicted</span><span class=o>==</span><span class=n>target</span><span class=p>)</span>
        <span class=n>accuracy</span> <span class=o>=</span> <span class=n>acc</span><span class=o>/</span><span class=nb>len</span><span class=p>(</span><span class=n>target</span><span class=p>)</span>  <span class=c1># accuracy</span>

        <span class=k>return</span> <span class=p>{</span> <span class=s1>&#39;NLL&#39;</span><span class=p>:</span> <span class=n>nll</span><span class=p>,</span> <span class=s1>&#39;CE&#39;</span><span class=p>:</span> <span class=n>ce</span><span class=p>,</span> <span class=s1>&#39;ACCURACY&#39;</span><span class=p>:</span> <span class=n>accuracy</span><span class=p>}</span>
</code></pre></div> <div class="admonition info"> <p class=admonition-title>Info</p> <p>Datasets for validation (<code>data</code> and <code>target</code>) are not a batch iterator. They contain all the samples in one block. However, it is possible to define batch iterator in the validation method as long as the method returns a single value for each metric that is calculated.</p> </div> <h3 id=sklearn>SkLearn</h3> <p>The validation method in scikit-learn based training plans also takes two arguments respectively for input/data (<code>X</code>) and target (<code>y</code>). These arguments are instances of <code>np.ndarray</code>.</p> <p>The following code snippet shows an example <code>testing_step</code> that calculates hinge loss and accuracy.</p> <div class=highlight><pre><span></span><code><span class=kn>from</span><span class=w> </span><span class=nn>fedbiomed.common.training_plans</span><span class=w> </span><span class=kn>import</span> <span class=n>FedPerceptron</span>
<span class=kn>from</span><span class=w> </span><span class=nn>sklearn.metrics</span><span class=w> </span><span class=kn>import</span> <span class=n>hinge_loss</span>
<span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>


<span class=k>class</span><span class=w> </span><span class=nc>SkLearnClassifierTrainingPlan</span><span class=p>(</span><span class=n>FedPerceptron</span><span class=p>):</span>
    <span class=k>def</span><span class=w> </span><span class=nf>init_dependencies</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>return</span> <span class=p>[</span><span class=s1>&#39;import torch&#39;</span><span class=p>,</span>
                <span class=s2>&quot;from sklearn.linear_model import Perceptron&quot;</span><span class=p>,</span>
                <span class=s2>&quot;from torchvision import datasets, transforms&quot;</span><span class=p>,</span>
                <span class=s2>&quot;from torch.utils.data import DataLoader&quot;</span><span class=p>,</span>
                <span class=s2>&quot;from sklearn.metrics import hinge_loss&quot;</span><span class=p>]</span>


    <span class=k>def</span><span class=w> </span><span class=nf>compute_accuracy_for_specific_digit</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>target</span><span class=p>,</span> <span class=n>digit</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
        <span class=n>idx_data_equal_to_digit</span> <span class=o>=</span> <span class=n>target</span> <span class=o>==</span> <span class=n>digit</span>

        <span class=n>predicted</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>model</span><span class=p>()</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=n>idx_data_equal_to_digit</span><span class=p>])</span>
        <span class=n>well_predicted_label</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sum</span><span class=p>(</span><span class=n>predicted</span> <span class=o>==</span> <span class=n>digit</span><span class=p>)</span> <span class=o>/</span> <span class=n>np</span><span class=o>.</span><span class=n>sum</span><span class=p>(</span><span class=n>idx_data_equal_to_digit</span><span class=p>)</span>
        <span class=k>return</span> <span class=n>well_predicted_label</span>

    <span class=k>def</span><span class=w> </span><span class=nf>testing_step</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>target</span><span class=p>):</span>
        <span class=c1># hinge loss</span>
        <span class=n>distance_from_hyperplan</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>model</span><span class=p>()</span><span class=o>.</span><span class=n>decision_function</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
        <span class=n>loss</span> <span class=o>=</span> <span class=n>hinge_loss</span><span class=p>(</span><span class=n>target</span><span class=p>,</span> <span class=n>distance_from_hyperplan</span><span class=p>)</span>

        <span class=c1># get the accuracy only on images representing digit 1</span>
        <span class=n>well_predicted_label_1</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>compute_accuracy_for_specific_digit</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>target</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>

        <span class=c1># Returning results as dict</span>
        <span class=k>return</span> <span class=p>{</span><span class=s1>&#39;Hinge Loss&#39;</span><span class=p>:</span> <span class=n>loss</span><span class=p>,</span> <span class=s1>&#39;Well Predicted Label 1&#39;</span> <span class=p>:</span> <span class=n>well_predicted_label_1</span><span class=p>}</span>
</code></pre></div> <h2 id=conclusion>Conclusion</h2> <p>The validation part in FL plays an important role in evaluating model performance that is trained on different nodes with different datasets. Applying a validation on the node side for each training round allows comparing the impacts of particular nodes on the trained model. Understanding and comparing different impacts will be clearer thanks to two types of validations: validation on aggregated parameters and validation on locally trained parameters.</p> </article> </main> </div> <div class=right-col> <div id=right-sidebar class=sidebar-right> <nav class=toc> <!-- Render item list --> <label class=toc-title for=__toc> <span class=toc-icon></span> </label> <ul class=toc-list data-md-component=toc data-md-scrollfix> <!-- Table of contents item --> <li class=toc-item> <a href=#default-metrics-provided-by-fed-biomed class=md-nav__link> Default Metrics Provided by Fed-BioMed </a> </li> <!-- Table of contents item --> <li class=toc-item> <a href=#validation-arguments class=md-nav__link> Validation Arguments </a> <nav class=toc-nav aria-label="Validation Arguments"> <ul class=toc-list> <!-- Table of contents item --> <li class=toc-item> <a href=#setting-validation-arguments-in-training-arguments class=md-nav__link> Setting Validation Arguments in Training Arguments </a> </li> <!-- Table of contents item --> <li class=toc-item> <a href=#setting-validation-arguments-using-setters-of-the-experiment-class class=md-nav__link> Setting Validation Arguments using Setters of the Experiment Class </a> </li> </ul> </nav> </li> <!-- Table of contents item --> <li class=toc-item> <a href=#using-validation-facility-with-heavy-datasets class=md-nav__link> Using Validation facility with heavy datasets </a> </li> <!-- Table of contents item --> <li class=toc-item> <a href=#define-custom-validation-step class=md-nav__link> Define Custom Validation Step </a> <nav class=toc-nav aria-label="Define Custom Validation Step"> <ul class=toc-list> <!-- Table of contents item --> <li class=toc-item> <a href=#pytorch class=md-nav__link> PyTorch </a> </li> <!-- Table of contents item --> <li class=toc-item> <a href=#sklearn class=md-nav__link> SkLearn </a> </li> </ul> </nav> </li> <!-- Table of contents item --> <li class=toc-item> <a href=#conclusion class=md-nav__link> Conclusion </a> </li> </ul> </nav> </div> </div> </div> </div> <!-- News Main Page--> </div> <footer> <div class=container-fluid> <div class=footer-first-inner> <div class=container> <div class=row> <div class=col-md-6> <div class=footer-contact> <strong>Address:</strong> <p>2004 Rte des Lucioles, 06902 Sophia Antipolis</p> <strong>E-mail:</strong> <p>fedbiomed _at_ inria _dot_ fr</p> </div> </div> <div class=col-md-6> <div class=footer-contact> <p>Fed-BioMed Â© 2022</p> </div> </div> </div> </div> </div> </div> </footer> <!-- JQuery --> <script src=https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js></script> <!-- Latest compiled and minified JavaScript --> <script src=https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js integrity=sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd crossorigin=anonymous></script> <script src=https://cdnjs.cloudflare.com/ajax/libs/tablesort/5.2.1/tablesort.min.js></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script> <script src=../../../assets/javascript/lunr.js></script> <script src=../../../assets/javascript/theme.js></script> </body> </html>